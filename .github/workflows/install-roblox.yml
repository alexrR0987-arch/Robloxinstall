name: Install Roblox

on:
  workflow_dispatch:

jobs:
  install:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Get Latest Roblox Installer
        run: |
          Invoke-WebRequest -Uri "https://setup.rbxcdn.com/RobloxPlayerInstaller.exe" -OutFile "RobloxPlayerInstaller.exe"

      - name: Install Roblox
        run: |
          Start-Process -FilePath "RobloxPlayerInstaller.exe" -ArgumentList "-quiet" -NoNewWindow -Wait

      - name: Find Installed Roblox Version Folder
        id: find_roblox
        run: |
          $RobloxRoot = "$env:LOCALAPPDATA\Roblox\Versions"
          $LatestVersionFolder = Get-ChildItem -Path $RobloxRoot -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          $RobloxExePath = "$RobloxRoot\$LatestVersionFolder\RobloxPlayerBeta.exe"

          echo "Roblox EXE Path: $RobloxExePath"
          echo "ROBLOX_EXE_PATH=$RobloxExePath" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "ROBLOX_FOLDER=$RobloxRoot\$LatestVersionFolder" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Create Windows Shortcut
        run: |
          $WScriptShell = New-Object -ComObject WScript.Shell
          $Shortcut = $WScriptShell.CreateShortcut("$env:ROBLOX_FOLDER\Roblox Install.lnk")
          $Shortcut.TargetPath = "$env:ROBLOX_EXE_PATH"
          $Shortcut.Save()
        shell: powershell

      - name: Package Installed Roblox into ZIP
        run: |
          Compress-Archive -Path "$env:ROBLOX_FOLDER\*" -DestinationPath "RobloxClient.zip"

      - name: Upload ZIP as Artifact
        uses: actions/upload-artifact@v2  # Updated to v2
        with:
          name: RobloxClient
          path: RobloxClient.zip
